error_log                       /etc/nginx/log/nginx-global/nginx-error.log;
proxy_http_version              1.1; #this is essential for chunked responses
proxy_buffering                 off;
proxy_set_header                X-Real-IP $remote_addr;
proxy_set_header                X-Forwarded-Proto $scheme;
proxy_set_header                X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header                Host $host;
proxy_intercept_errors          on;

map $status $loggable {
        ~^[3]  0;
        default 1;
}

# proxies --------------------------------------------------------

upstream cedar-frontend {
        server <cedar.CEDAR_FRONTEND_HOST>:4200;
}

upstream cedar-backend-folder {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9008;
}

upstream cedar-backend-group {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9009;
}

upstream cedar-backend-repo {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9002;
}

upstream cedar-backend-resource {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9007;
}

upstream cedar-backend-schema {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9003;
}

upstream cedar-backend-submission {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9010;
}

upstream cedar-backend-template {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9001;
}

upstream cedar-backend-terminology {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9004;
}

upstream cedar-backend-user {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9005;
}

upstream cedar-backend-valuerecommender {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9006;
}

upstream cedar-backend-worker {
        server <cedar.CEDAR_MICROSERVICE_HOST>:9011;
}

upstream cedar-backend-auth {
        server <cedar.CEDAR_KEYCLOAK_HOST>:8080;
}

# no subdomain --------------------------------------------------------

server {
        listen               80;
        server_name          <cedar.CEDAR_HOST>;
        return               301 https://cedar.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443;
        server_name          <cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        return               301 https://cedar.<cedar.CEDAR_HOST>$request_uri;
}

# frontend --------------------------------------------------------

server {
        listen               80;
        server_name          cedar.<cedar.CEDAR_HOST>;
        return               301 https://cedar.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          cedar.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-frontend;
        }
        error_log            /etc/nginx/log/nginx-frontend/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-frontend/nginx-access.log combined if=$loggable;
}

# folder --------------------------------------------------------

server {
        listen               80;
        server_name          folder.<cedar.CEDAR_HOST>;
        return               301 https://folder.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          folder.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-folder;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-folder/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-folder/nginx-access.log combined if=$loggable;
}

# group --------------------------------------------------------

server {
        listen               80;
        server_name          group.<cedar.CEDAR_HOST>;
        return               301 https://group.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          group.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-group;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-group/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-group/nginx-access.log combined if=$loggable;
}

# repo --------------------------------------------------------

server {
        listen               80;
        server_name          repo.<cedar.CEDAR_HOST>;
        return               301 https://repo.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          repo.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-repo;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-repo/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-repo/nginx-access.log combined if=$loggable;
}

# resource --------------------------------------------------------

server {
        listen               80;
        server_name          resource.<cedar.CEDAR_HOST>;
        return               301 https://resource.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          resource.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-resource;
        }
        location /api {
                alias        /usr/local/etc/cedar-swagger-ui;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-resource/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-resource/nginx-access.log combined if=$loggable;
}

# schema --------------------------------------------------------

server {
        listen               80;
        server_name          schema.<cedar.CEDAR_HOST>;
        return               301 https://schema.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          schema.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-schema;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-schema/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-schema/nginx-access.log combined if=$loggable;
}

# submission --------------------------------------------------------

server {
        listen               80;
        server_name          submission.<cedar.CEDAR_HOST>;
        return               301 https://submission.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          submission.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-submission;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-submission/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-submission/nginx-access.log combined if=$loggable;
}

# template --------------------------------------------------------

server {
        listen               80;
        server_name          template.<cedar.CEDAR_HOST>;
        return               301 https://template.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          template.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-template;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-template/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-template/nginx-access.log combined if=$loggable;
}

# terminology --------------------------------------------------------

server {
        listen               80;
        server_name          terminology.<cedar.CEDAR_HOST>;
        return               301 https://terminology.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          terminology.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-terminology;
        }
        location /api {
                alias        /usr/local/etc/cedar-swagger-ui;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-terminology/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-terminology/nginx-access.log combined if=$loggable;
}

# user --------------------------------------------------------

server {
        listen               80;
        server_name          user.<cedar.CEDAR_HOST>;
        return               301 https://user.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          user.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-user;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-user/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-user/nginx-access.log combined if=$loggable;
}

# valuerecommender --------------------------------------------------------

server {
        listen               80;
        server_name          valuerecommender.<cedar.CEDAR_HOST>;
        return               301 https://valuerecommender.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          valuerecommender.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-valuerecommender;
        }
        location /api {
                alias        /usr/local/etc/cedar-swagger-ui;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-valuerecommender/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-valuerecommender/nginx-access.log combined if=$loggable;
}

# worker --------------------------------------------------------

server {
        listen               80;
        server_name          worker.<cedar.CEDAR_HOST>;
        return               301 https://worker.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          worker.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-worker;
        }
        error_page           502 /errors/502.json;
        location             ^~ /errors/ {
                internal;
                root         /etc/nginx/cedar/static/;
        }
        error_log            /etc/nginx/log/nginx-worker/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-worker/nginx-access.log combined if=$loggable;
}

# auth --------------------------------------------------------

server {
        listen               80;
        server_name          auth.<cedar.CEDAR_HOST>;
        return               301 https://auth.<cedar.CEDAR_HOST>$request_uri;
}

server {
        listen               443 ssl;
        server_name          auth.<cedar.CEDAR_HOST>;
        include              cedar/ssl.conf;
        location / {
                proxy_pass   http://cedar-backend-auth;
        }
        error_log            /etc/nginx/log/nginx-auth/nginx-error.log warn;
        access_log           /etc/nginx/log/nginx-auth/nginx-access.log combined if=$loggable;
}